FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

# install basic deps & iovisor repo, then install bcc packages (binary)
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates curl gnupg lsb-release python3 python3-pip \
    zip wget git && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Add iovisor repo (upstream signed packages) - per INSTALL.md
RUN apt-get update && apt-get install -y --no-install-recommends dirmngr gnupg && \
    apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 4052245BD4284CDD || true && \
    echo "deb https://repo.iovisor.org/apt $(lsb_release -cs) main" > /etc/apt/sources.list.d/iovisor.list && \
    apt-get update && \
    apt-get install -y --no-install-recommends bcc-tools libbcc-examples python3-bcc || \
    apt-get install -y --no-install-recommends bpfcc-tools python3-bpfcc || true && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Note: do NOT try to install linux-headers-$(uname -r) here in the image build,
# it typically fails in containers. Instead mount host headers/modules at runtime.

# Clone your analyzer
WORKDIR /home/ubuntu
RUN git clone https://github.com/aws/aws-imds-packet-analyzer.git /home/ubuntu/aws-imds-packet-analyzer

# Overwrite the cloned script with the local workspace version if present
# This ensures the image runs the edited `imds_snoop.py` from this repo/workspace.
COPY imds_snoop.py /home/ubuntu/aws-imds-packet-analyzer/src/imds_snoop.py

ENV LD_PRELOAD=/usr/lib/libbcc.so.0
# adjust PYTHONPATH if needed depending on package install paths; distro usually puts bindings under /usr/lib/python3/dist-packages
ENV PYTHONPATH=/usr/lib/python3/dist-packages

WORKDIR /home/ubuntu/aws-imds-packet-analyzer
CMD ["python3", "src/imds_snoop.py"]
